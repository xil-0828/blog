---
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Footer from "../components/Footer.astro";
import FormattedDate from "../components/FormattedDate.astro";
import Header from "../components/Header.astro";
import { SITE_TITLE } from "../consts";

type Props = CollectionEntry<"blog">["data"];
const { title, description, summary, tags, pubDate, updatedDate, heroImage, youtubeId, } =
  Astro.props;

const metaDescription = summary ?? description;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);

// Article JSON-LD
const articleJsonLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "@id": canonicalURL.toString(),
  keywords: tags?.join(", "),
  headline: title,
  description: metaDescription,
  datePublished: pubDate.toISOString(),
  inLanguage: "ja",
  ...(updatedDate ? { dateModified: updatedDate.toISOString() } : {}),

  // Ë®ò‰∫ã„ÅÆ‰ª£Ë°®ÁîªÂÉèÔºà‰ªä„Åæ„ÅßÈÄö„ÇäÔºâ
  ...(heroImage
    ? {
        image: {
          "@type": "ImageObject",
          url: new URL(heroImage.src, Astro.site).toString(),
          width: 1020,
          height: 510,
        },
      }
    : {}),

  // üî• YouTube „Åå„ÅÇ„ÇãÂ†¥Âêà„Å†„Åë VideoObject „ÇíËøΩÂä†
  ...(youtubeId
    ? {
        video: [
          {
            "@type": "VideoObject",
            name: title,
            description: metaDescription,
            embedUrl: `https://www.youtube.com/embed/${youtubeId}`,
            contentUrl: `https://www.youtube.com/watch?v=${youtubeId}`,
            thumbnailUrl: `https://i.ytimg.com/vi/${youtubeId}/hqdefault.jpg`,
            uploadDate: pubDate.toISOString(),
            inLanguage: "ja",
            publisher: {
              "@id": "https://almondis.com/#organization",
            },
            potentialAction: {
              "@type": "WatchAction",
              target: `https://www.youtube.com/watch?v=${youtubeId}`,
            },
          },
        ],

      }
    : {}),

  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": canonicalURL.toString(),
  },

  author: {
    "@type": "Person",
    "@id": "https://almondis.com/#author",
    name: "Almond",
  },

  publisher: {
    "@type": "Organization",
    "@id": "https://almondis.com/#organization",
    name: SITE_TITLE,
    logo: {
      "@type": "ImageObject",
      url: "https://almondis.com/logo.png",
      width: 512,
      height: 512,
    },
  },
};


// Breadcrumb JSON-LD
const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "Home",
      item: "https://almondis.com",
    },
    {
      "@type": "ListItem",
      position: 2,
      name: "Blog",
      item: "https://almondis.com/blog",
    },
    {
      "@type": "ListItem",
      position: 3,
      name: title,
      item: canonicalURL.toString(),
    },
  ],
};
---

<html lang="ja">
  <head>
    <BaseHead
      title={title}
      description={metaDescription}
      image={heroImage}
      ogType="article"
      pubDate={pubDate}
      updatedDate={updatedDate}
    />
    

    <!-- Article structured data -->
    <script
      type="application/ld+json"
      set:html={JSON.stringify(articleJsonLd)}
    />

    <!-- Breadcrumb structured data -->
    <script
      type="application/ld+json"
      set:html={JSON.stringify(breadcrumbJsonLd)}
    />
    <style is:inline>
      .article-main {
        width: 720px;
        max-width: calc(100% - 2em);
        margin: 0 auto;
      }

      img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
      }
      hr {
	border: none;
	border-top: 1px solid rgb(var(--gray-light));
}


    </style>
  </head>

  <body class="bg-white text-black flex flex-col gap-[64px]">
    <Header />

    <main class="article-main w-full flex justify-center">
      <article class="w-full max-w-[720px] px-4 py-10">
        {
  (
    heroImage && (
      <Image
        src={heroImage}
        widths={[360, 480, 720]}
        sizes="(max-width: 480px) 92vw, (max-width: 1024px) 720px, 720px"
        format="avif"
        quality={40}
        alt={title}
        loading="eager"
        fetchpriority="high"
        decoding="async"
      />
    )
  )
}


        <div class="text-center mb-16">
          <div class="flex justify-center items-center gap-4 my-4">
            <p class="text-sm text-gray-500">
              ‰ΩúÊàêÊó• <FormattedDate date={pubDate} />
            </p>

            {
              updatedDate && (
                <p class="text-sm text-gray-500">
                  Êõ¥Êñ∞Êó• <FormattedDate date={updatedDate} />
                </p>
              )
            }
          </div>

          <h1 class="text-3xl font-bold mt-4">{title}</h1>
          <hr class="mt-6" />
        </div>

        <div class="markdown-body mx-auto">
          <slot />
        </div>

        <!-- {
          (summary || description) && (
            <p class="text-base text-muted-foreground mt-3">
              {summary ?? description}
            </p>
          )
        } -->

        {
          tags?.length ? (
            <div class="mt-4 flex flex-wrap justify-center gap-2">
              {tags.map((tag) => (
                <span class="text-sm font-medium px-2.5 py-1 rounded-md bg-gray-100 text-gray-900">
                  #{tag}
                </span>
              ))}
            </div>
          ) : null
        }
      </article>
    </main>

    <Footer />
  </body>
</html>
